# Program that fits a classififcation tree on NASA data
# BY Kenneth Kamogelo Baloyi

library(rpart)
library(rpart.plot)

setwd("C:/Users/Kenneth Kamogelo/OneDrive - University of Cape Town/Desktop/CSIR/Vac work/Code")

df <- read.csv("balanced_discharge_data.csv")
# Make sure battery column is factor
df$battery <- as.factor(df$battery)

# Split data
set.seed(42) #Ensures reproducibility of the same sample generated by
#the sample function
split <- sample(1:nrow(df), size = 0.8 * nrow(df))
train <- df[split, ] #80% of the data from the split variable goes to
#the training batch
test <- df[-split, ] #Remaining 20% goes to the test batch



#Build the classification tree
battery_tree <- rpart(battery ~ voltage_measured + current_measured + temperature_measured,
                      data = train, method = "class")

#Visualize the classification tree
rpart.plot(battery_tree, type = 4, extra = 104, fallen.leaves = TRUE, cex=0.6, gap=0.005)
print(battery_tree)


#Predict battery type
pred_battery <- predict(battery_tree, test, type = "class")
conf_mat <- table(Predicted = pred_battery, Actual = test$battery)
#Compute overall accuracy using confusion matrix
accuracy <- sum(diag(conf_mat)) / sum(conf_mat)
print(paste("Accuracy:", round(accuracy * 100, 0), "%"))

#PRECISION
#TO know which batteries have a high classification rate using the tree


precision_b5 <- conf_mat["B0005", "B0005"] / sum(conf_mat["B0005", ])
precision_b6 <- conf_mat["B0006", "B0006"] / sum(conf_mat["B0006", ])
precision_b7 <- conf_mat["B0007", "B0007"] / sum(conf_mat["B0007", ])
precision_b18 <- conf_mat["B0018", "B0018"] / sum(conf_mat["B0018",])

print("Precision:\n")
cat("B0005:", round(precision_b5, 3), "\n")
cat("B0006:", round(precision_b6, 3), "\n")
cat("B0007:", round(precision_b7, 3), "\n")
cat("B0018:", round(precision_b18, 3), "\n")

# Load new battery data (e.g., unseen test battery)
new_battery <- read.csv("B0005.csv")
new_battery <- new_battery[1:2916, ]

# Predict battery type for each row
battery_prediction <- predict(battery_tree, new_battery, type = "class")

# Show predicted battery type counts
cat("\nPredicted battery type distribution for B0006.csv:\n")
print(table(battery_prediction))

# Optionally print majority vote
most_common <- names(sort(table(battery_prediction), decreasing = TRUE))[1]
cat("\nMajority predicted battery type for B0006.csv:", most_common, "\n")

